<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanePal API</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
    <div id="errorPopup" class="error-popup hidden"></div>

    <div class="container">
        <div class="content">
            <div class="header">
                <!--<img src="favicon.ico" class="logo">-->
                <h1 class="title">PlanePal API</h1>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <p class="stat-label">Server Count</p>
                    <p class="stat-value" id="serverCount">-</p>
                </div>
                <div class="stat-card">
                    <p class="stat-label">Member Count</p>
                    <p class="stat-value" id="memberCount">-</p>
                </div>
            </div>

            <div class="button-container">
                <button class="button button-refresh" onclick="handleRefresh(this)">
                    <span>Refresh</span>
                </button>
                <a href="https://github.com/DevJSTAR/planepal-api/blob/main/README.md" target="_blank" class="button button-learn">
                    Learn More
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/>
                        <line x1="10" y1="14" x2="21" y2="3"/>
                    </svg>
                </a>
            </div>
        </div>
    </div>

    <script>
        async function fetchData() {
            try {
                const response = await fetch('https://api.github.com/repos/DevJSTAR/planepal-api/contents/api/data.json');
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: Server responded with an error!`);
                }
                const data = await response.json();
                const decodedContent = JSON.parse(atob(data.content));
                return decodedContent;
            } catch (error) {
                const errorMessage = error.message.includes('NetworkError') || error.message === 'Failed to fetch'
                    ? 'Network Error: Unable to reach the server.'
                    : error.message;
                showErrorPopup(errorMessage);
                return null;
            }
        }

	function animateValue(element, start, end, duration) {
            let startTimestamp = null;
   	    const step = (timestamp) => {
         	if (!startTimestamp) startTimestamp = timestamp;
        	const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        	const currentValue = Math.floor(progress * (end - start) + start);
        	element.textContent = currentValue.toLocaleString();
        	if (progress < 1) {
            	    window.requestAnimationFrame(step);
        	}
    	    };
            window.requestAnimationFrame(step);
	}

        async function updateStats(animate = true) {
            const data = await fetchData();
            const serverCountElement = document.getElementById('serverCount');
            const memberCountElement = document.getElementById('memberCount');

            if (!data) {
                serverCountElement.textContent = '-';
                memberCountElement.textContent = '-';
                return;
            }

            if (animate) {
                animateValue(serverCountElement, 0, data.serverCount, 2000);
                animateValue(memberCountElement, 0, data.memberCount, 2000);
            } else {
                serverCountElement.textContent = data.serverCount.toLocaleString();
                memberCountElement.textContent = data.memberCount.toLocaleString();
            }
        }

        function showErrorPopup(message) {
            const errorPopup = document.getElementById('errorPopup');
            errorPopup.textContent = message;
            errorPopup.classList.remove('hidden', 'slide-up');
            errorPopup.classList.add('slide-down');
            
            setTimeout(() => {
                errorPopup.classList.remove('slide-down');
                errorPopup.classList.add('slide-up');
            }, 5000);
        }

        async function handleRefresh(button) {
            button.classList.add('loading');
            button.disabled = true;

            await updateStats(true);

            setTimeout(() => {
                button.classList.remove('loading');
                button.disabled = false;
            }, 2000);
        }

        updateStats(true);
    </script>
</body>
</html>
